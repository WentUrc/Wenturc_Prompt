name: Deploy Frontend to GitHub Pages

# è§¦å‘æ¡ä»¶: å½“ main åˆ†æ”¯æœ‰æ¨é€æ—¶è¿è¡Œ
on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:

# æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸å†™å…¥åˆ†æ”¯
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„å†å²è®°å½•      # Step 2: è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # ä½¿ç”¨ npm ç¼“å­˜
          cache-dependency-path: './package-lock.json'

      # Step 3: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # Step 4: æ„å»ºé¡¹ç›®
      - name: Build with Vite
        run: npm run build
        env:
          NODE_ENV: production

      # Step 5: åˆ›å»º .nojekyll æ–‡ä»¶
      - name: Create .nojekyll file
        run: echo "" > dist/.nojekyll      # Step 6: åˆ›å»ºæ„å»ºäº§ç‰©å‹ç¼©åŒ…
      - name: Create dist archive
        run: |
          cd dist
          zip -r ../dist-${{ github.sha }}.zip .
          cd ..
            # Step 7: éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      - name: Deploy to gh-pages branch
        uses: JamesIves/github-pages-deploy-action@v4.4.3
        with:
          branch: gh-pages  # å°†æ–‡ä»¶éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
          folder: dist  # ä½¿ç”¨ dist ç›®å½•ä½œä¸ºé™æ€æ–‡ä»¶æºï¼ˆç›¸å¯¹äºå·¥ä½œç›®å½•ï¼‰
          clean: true  # æ¸…ç†ç›®æ ‡åˆ†æ”¯ä¸­çš„æ—§æ–‡ä»¶
          single-commit: true  # ä½¿ç”¨å•æ¬¡æäº¤è€Œä¸æ˜¯ä¿ç•™å†å²
          
      # Step 8: è·å–æ„å»ºæ—¶é—´
      - name: Get build time
        id: build_time
        run: |
          BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          
      # Step 9: åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
      - name: Create version tag
        id: create_tag
        run: |
          VERSION="v$(date +'%Y.%m.%d.%H%M')"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git tag $VERSION
          git push origin $VERSION          
      # Step 10: åˆ›å»º Release å¹¶ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Create Release with dist
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.VERSION }}
          name: "Auto Deploy ${{ steps.create_tag.outputs.VERSION }}"
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºéƒ¨ç½²
            
            **æ„å»ºä¿¡æ¯:**
            - æäº¤: ${{ github.sha }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æ„å»ºæ—¶é—´: ${{ steps.build_time.outputs.BUILD_TIME }}
            
            **éƒ¨ç½²æ–‡ä»¶:**
            - `dist-${{ github.sha }}.zip` - å®Œæ•´çš„å‰ç«¯æ„å»ºäº§ç‰©
            
            **æœåŠ¡å™¨éƒ¨ç½²:**
            æœåŠ¡å™¨å°†åœ¨1å°æ—¶å†…è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²æ­¤ç‰ˆæœ¬ã€‚
          files: |
            dist-${{ github.sha }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
